% M 0,10 C -1,2 0,0 5,5
% function parse_svg(svg_str)
% end

% M 0,10 C -1,2 2,3 5,5 8,7 8,0 11,3

function [P, Pd, Pdd] = bezier_path_generator(bezier_path_svg)

% Seg: cell array containing cubic Bezier segments

p = @(s, X) ...
    (1-s).^3             .* X(:,1) + ...
    3*s      .* (1-s).^2 .* X(:,2) + ...
    3*s.^2   .* (1-s)    .* X(:,3) + ...
    s.^3                 .* X(:,4);

dp_ds = @(s, X) ...
    3*(1-s).^2 .* (X(:,2) - X(:,1)) + ...
    6*(1-s).*s .*(X(:,3)-X(:,2)) + ...
    3*s.^2.*(X(:,4) - X(:,3));

d2p_ds2 = @(s, X) ...
    6*(1-s).*(X(:,3)-2*X(:,2)+X(:,1)) + ...
    6*s.*(X(:,4)-2*X(:,3)+X(:,2));


% data = 'm 44.709677,24.971774 c -2.705645,-1.46371 -3.282259,-3.592742 -0.133064,-7.451613 3.149193,-3.858871 7.762096,0.887096 10.91129,-1.197581';
% data = 'm 60.419354,35.104839 c -2.705645,-1.46371 -3.858871,-2.83871 -0.709676,-6.697581 3.149193,-3.858871 6.915322,-4.629032 7.915322,-2.629032 1,2 4.310484,-1 1.310484,-7';
% data = 'm 120.37352,98.105364 c 0,0 4.45364,23.961796 -1.50545,28.164516 -5.95908,4.20272 -5.14363,-8.46817 -3.19909,-9.97363 1.94455,-1.50545 9.47181,5.58273 19.25726,-6.27272 9.78544,-11.855442 3.19908,-18.316344 0.94091,-16.999071 -2.25818,1.31727 -8.46818,26.408161 -3.82636,33.433601 4.64181,7.02545 7.4018,-0.75272 8.7818,-9.65999 1.38,-8.90726 0.37636,-10.47544 0.37636,-10.47544';
% data = 'm -21.954526,153.11712 c 0,0 3.073633,15.17998 -0.06273,25.02816 -3.13636,9.84817 -9.534538,-4.57909 -4.70454,-8.53091 4.829995,-3.95181 14.36453,-0.9409 18.567254,-5.95908 4.202724,-5.01818 5.394539,-13.04726 1.81909,-15.36817 -3.575452,-2.3209 -7.715449,17.31271 -5.833631,28.10179 1.881817,10.78909 6.837267,6.58636 8.719081,-1.44272 1.8818171,-8.02909 9.5972661,-10.66363 8.9072641,-13.73726 -0.689999,-3.07364 -2.697268,-4.89273 -4.95545,-1.88182 -2.2581791,3.01091 -4.1399961,10.22454 0.06273,13.86272 4.202723,3.63817 15.8072529,-13.04726 17.3127129,-22.51907 1.50545,-9.47181 -7.9036319,0.31363 -7.652722,9.15817 0.136857,4.82417 0.0062,9.36059 0.991308,12.8344 0.820978,2.89501 1.83138,4.64943 3.901414,3.91377 5.46368,-1.94172 12.41999,-19.94726 12.85908,-25.78089 0.43909,-5.83363 -4.78153,-5.97801 -5.39454,-2.07 -0.58872,3.75314 -6.41632,17.74394 -1.12909,25.96907 5.85389,9.10665 6.83726,-10.91453 8.84454,-13.92544 1.96121,-2.94181 3.95181,-2.38364 4.89272,1.81909 0.94091,4.20272 0.62727,9.34635 -3.32454,9.97363 -3.95182,0.62727 -3.27983,-8.32026 -1.50546,-8.78182 1.77437,-0.46156 1.68132,2.97334 3.37672,3.72924 1.7415,0.77645 4.137,-0.88411 6.346,-3.76059';
% data = 'm -21.954526,209.89131 c 1.079169,4.61234 3.073633,15.17998 -0.06273,25.02816 -3.13636,9.84817 -9.534538,-4.57909 -4.70454,-8.53091 4.829995,-3.95181 14.36453,-0.9409 18.567254,-5.95908 4.202724,-5.01818 5.394539,-13.04726 1.81909,-15.36817 -3.575452,-2.3209 -7.715449,17.31271 -5.833631,28.10179 1.881817,10.78909 6.837267,6.58636 8.719081,-1.44272 1.8818171,-8.02909 9.5972661,-10.66363 8.9072641,-13.73726 -0.689999,-3.07364 -2.697268,-4.89273 -4.95545,-1.88182 -2.2581791,3.01091 -4.1399961,10.22454 0.06273,13.86272 4.202723,3.63817 15.8072529,-13.04726 17.3127129,-22.51907 1.50545,-9.47181 -7.9036319,0.31363 -7.652722,9.15817 0.136857,4.82417 0.0062,9.36059 0.991308,12.8344 0.820978,2.89501 1.83138,4.64943 3.901414,3.91377 5.46368,-1.94172 12.41999,-19.94726 12.85908,-25.78089 0.43909,-5.83363 -4.78153,-5.97801 -5.39454,-2.07 -0.58872,3.75314 -6.41632,17.74394 -1.12909,25.96907 5.85389,9.10665 6.83726,-10.91453 8.84454,-13.92544 1.96121,-2.94181 3.95181,-2.38364 4.89272,1.81909 0.94091,4.20272 0.62727,9.34635 -3.32454,9.97363 -3.95182,0.62727 -3.27983,-8.32026 -1.50546,-8.78182 1.77437,-0.46156 1.68132,2.97334 3.37672,3.72924 1.7415,0.77645 5.2415,-2.32235 6.346,-3.76059 0.573087,-0.74625 -12.868018,-29.39505 -29.093058,-31.94963 -15.045189,-2.36883 -34.023322,16.70502 -32.944153,21.31736';
% data = 'm -74.203258,39.592344 c 0.791745,4.533074 1.727451,18.423785 -2.530613,22.149592 -4.258064,3.725806 -9.935483,-4.435486 -3.282258,-8.072581 6.653226,-3.637097 20.403226,-1.153226 19.16129,-13.129032 -1.241935,-11.975806 -8.25,-2.040324 -7.629032,6.741935 0.620968,8.782256 0.887097,18.096772 3.814516,17.830644 2.92742,-0.266129 4.080645,-11.887097 6.298387,-13.749999 2.217742,-1.862905 5.233871,-0.177419 5.677419,-2.927419 0.443549,-2.749999 -0.709677,-6.298387 -3.104838,-4.258066 -2.395161,2.040324 -3.193549,6.653225 -2.483871,9.580647 0.709677,2.927419 1.153226,5.056449 3.637097,4.169354 2.483871,-0.887097 5.943548,-4.169354 6.830645,-7.185485 0.887096,-3.016128 1.064516,-5.056449 -0.17742,-4.790321 -1.241935,0.266129 -1.064516,7.008064 -0.08871,8.693547 0.975806,1.685486 3.016129,2.75 4.080645,0.620969 1.064516,-2.129033 3.983019,-6.986541 3.983019,-8.051058 0,-1.064514 -1.110176,-1.460557 -1.553724,0.934605 -0.443549,2.395162 3.780382,7.116453 1.828769,13.947098 -1.951613,6.830644 -3.193548,10.999999 -5.943548,8.693549 -2.749999,-2.306452 -2.749999,-8.782259 1.241936,-10.645164 3.991936,-1.862902 8.693548,-5.145159 9.846774,-10.911289 0.584631,-2.923156 -10.155806,-7.061054 -21.07457,-9.008141 -10.619252,-1.893676 -19.323658,-5.166458 -18.531913,-0.633385';

% data = 'm 29.428744,39.580872 c 0,0 4.265451,21.327253 -1.944543,24.651795 -6.209994,3.324543 -5.394541,-7.966358 -2.69727,-9.848172 2.69727,-1.881817 16.497257,-2.069999 17.814528,-5.143632 1.317272,-3.073633 4.51636,-13.109988 0.752727,-14.239079 -3.763633,-1.129088 -7.966356,18.379075 -5.331814,25.529977 2.634543,7.150904 6.209995,4.014541 7.527266,0 1.317272,-4.014542 8.969992,-11.541808 8.217266,-14.239076 -0.752727,-2.697271 -8.468174,-3.324543 -7.464539,3.951814 1.003635,7.276356 2.822725,9.534535 6.52363,7.8409 3.700906,-1.693635 3.512724,-11.039988 5.708177,-12.043624 2.195452,-1.003636 2.069998,7.150902 3.951814,8.154538 1.881817,1.003636 5.018177,-0.564544 5.143632,-4.328179 0.125454,-3.763631 -4.077269,-4.829995 -4.328178,-2.258179 -0.250909,2.571816 8.844537,14.678168 5.269086,18.504527 -3.575451,3.826362 -13.047261,6.586358 -10.977263,-3.13636';
% data = 'm 29.428744,39.580872 c -2.168701,5.941271 4.265451,21.327253 -1.944543,24.651795 -6.209994,3.324543 -5.394541,-7.966358 -2.69727,-9.848172 2.69727,-1.881817 16.497257,-2.069999 17.814528,-5.143632 1.317272,-3.073633 4.51636,-13.109988 0.752727,-14.239079 -3.763633,-1.129088 -7.966356,18.379075 -5.331814,25.529977 2.634543,7.150904 6.209995,4.014541 7.527266,0 1.317272,-4.014542 8.969992,-11.541808 8.217266,-14.239076 -0.752727,-2.697271 -8.468174,-3.324543 -7.464539,3.951814 1.003635,7.276356 2.822725,9.534535 6.52363,7.8409 3.700906,-1.693635 3.512724,-11.039988 5.708177,-12.043624 2.195452,-1.003636 2.069998,7.150902 3.951814,8.154538 1.881817,1.003636 6.260112,-0.564544 6.385567,-4.328179 0.125454,-3.763631 -3.012752,-4.120318 -3.263661,-1.548502 -0.250909,2.571816 3.876795,15.920104 0.301344,19.746463 C 62.333785,71.892457 61.348587,66.73061 58.569069,61.913606 55.789551,57.096602 31.597445,33.639601 29.428744,39.580872';

% data = 'm 107.86552,48.127388 c -2.44621,5.797005 3.51272,20.888162 -2.69728,24.212704 -6.20999,3.324543 -5.394537,-7.966358 -2.69727,-9.848172 2.69727,-1.881817 16.49726,-2.069999 17.81453,-5.143632 1.31727,-3.073633 4.51636,-13.109988 0.75273,-14.239079 -3.76363,-1.129088 -7.96636,18.379075 -5.33181,25.529977 2.63454,7.150904 6.20999,4.014541 7.52726,0 1.31727,-4.014542 8.96999,-11.541808 8.21727,-14.239076 -0.75273,-2.697271 -8.46818,-3.324543 -7.46454,3.951814 1.00363,7.276356 2.82272,9.534535 6.52363,7.8409 3.7009,-1.693635 3.51272,-11.039988 5.70818,-12.043624 2.19545,-1.003636 2.06999,7.150902 3.95181,8.154538 1.88182,1.003636 6.26011,-0.564544 6.38557,-4.328179 0.12545,-3.763631 -3.01276,-4.120318 -3.26366,-1.548502 -0.25091,2.571816 3.87679,15.920104 0.30134,19.746463 -3.57545,3.826362 -5.57719,-2.725131 -7.27744,-5.399762 -1.70025,-2.674631 -26.00411,-28.443375 -28.45032,-22.64637';


Seg = svg_bezier_parser(bezier_path_svg);
Seg = cellfun(@yRef, Seg, 'UniformOutput', false);

X = [];
for i=1:numel(Seg)
    X = [X, Seg{i}];
end
[x_min, x_max, y_min, y_max] = ...
    deal(min(X(1,:)), max(X(1,:)), min(X(2,:)), max(X(2,:)));

X = X - [x_min;y_min];

[m,~] = max(vecnorm(X, Inf));
% manually play with m here.
SMat = 1/m * eye(2);
X = SMat*X;


for i=1:numel(Seg)
    S{i} = X(:,(4*i-3):4*i);
end



s = 0:.01:1;
N = numel(s);
figure;
k = numel(S);
P = [];
Pd = [];
Pdd = [];
for i=1:numel(S)
    P = [P, p(s, S{i})];
    Pd = [Pd, dp_ds(s, S{i})];
    Pdd = [Pdd, d2p_ds2(s, S{i})];
end
dup_idx = N*(1:k-1);
P(:,dup_idx) = [];
Pd(:,dup_idx) = [];
Pdd(:,dup_idx) = [];
ss = 0:.01:k;

tiledlayout(6,2,"TileSpacing","compact","Padding","compact");


nexttile(1)
plot(ss, P(1,:));
nexttile(3);
plot(ss, Pd(1,:));
nexttile(5);
plot(ss, Pdd(1,:));

nexttile(2);
plot(ss, P(2,:));
nexttile(4);
plot(ss, Pd(2,:));
nexttile(6);
plot(ss, Pdd(2,:));

nexttile(7,[3,2]);
plot(P(1,:), P(2,:));
hold on;
plot(X(1,:), X(2,:), 'bo');
xline(0);
yline(0);
xline(1);
yline(1);


axis equal;





end

function An = yRef(A)
T = [1 0;0 -1];
An = T*A;
end


